# Testing Migration Notes

`pytest` + `pytest-django` is the right baseline for this repo: pytest gives simple `assert`-based tests and composable fixtures, while pytest-django adds Django-aware fixtures/markers (`django_db`, `client`, `settings`, query-count helpers) so we can replace large `APITestCase` classes with smaller function tests and shared `conftest.py` setup. For DRF coverage, we can keep endpoint tests centered on `APIClient` and only use `APIRequestFactory` + `force_authenticate` when directly unit-testing view callables. (Context7: `/websites/pytest_en_stable` topic `Getting Started and writing tests with plain assert, fixture usage, test discovery conventions, and pytest.ini options`; Context7: `/pytest-dev/pytest-django` topic `Database access markers, django_db fixture behavior, django_db_setup, client/admin_client fixtures, settings fixture, and running manage commands`; Context7: `/websites/django-rest-framework` topic `Testing APIs: APIClient, APIRequestFactory, force_authenticate, APITestCase patterns and equivalents`)

For performance and reliability, `pytest-xdist` and `pytest-cov` can be layered in without changing test semantics: use `-n auto` or explicit worker counts for parallel runs, and coverage options like `--cov`, `--cov-branch`, and `--cov-fail-under` for quality gates. Optional `pytest-randomly` is useful to detect hidden inter-test coupling if we capture/reuse seeds, and `factory_boy` can reduce fixture boilerplate for model graphs if we keep factories deterministic. (Context7: `/pytest-dev/pytest-xdist` topic `Parallel test execution with -n, load scheduling modes, worker isolation caveats, and known limitations`; Context7: `/pytest-dev/pytest-cov` topic `Coverage reporting commands, branch coverage, fail-under thresholds, and interaction with xdist`; Web: `https://github.com/pytest-dev/pytest-randomly#readme`; Web: `https://pypi.org/project/pytest-randomly/`; Context7: `/websites/factoryboy_readthedocs_io_en_stable` topic `DjangoModelFactory patterns, SubFactory, RelatedFactory, and deterministic faker/sequence practices`)

Key gotchas
- `pytest-django` blocks DB access unless the test is marked with `@pytest.mark.django_db` (or uses a DB fixture), so accidental ORM usage fails fast. (Context7: `/pytest-dev/pytest-django` topic `Database access markers, django_db fixture behavior, django_db_setup, client/admin_client fixtures, settings fixture, and running manage commands`)
- `--reuse-db` speeds local loops but schema changes may require `--create-db` to rebuild test DB state. (Context7: `/pytest-dev/pytest-django` topic `Database access markers, django_db fixture behavior, django_db_setup, client/admin_client fixtures, settings fixture, and running manage commands`)
- xdist requires deterministic collection/params across workers; avoid unordered parametrization inputs like raw sets. (Context7: `/pytest-dev/pytest-xdist` topic `Parallel test execution with -n, load scheduling modes, worker isolation caveats, and known limitations`)
- Coverage and xdist work together, but fail thresholds should be explicit (`--cov-fail-under`) so CI behavior is predictable. (Context7: `/pytest-dev/pytest-cov` topic `Coverage reporting commands, branch coverage, fail-under thresholds, and interaction with xdist`)
- For DRF tests, `APIClient.force_authenticate(...)` is global to the client until reset (`user=None`), and `force_authenticate(request, user=...)` is the direct-view equivalent for factory requests. (Context7: `/websites/django-rest-framework` topic `Testing APIs: APIClient, APIRequestFactory, force_authenticate, APITestCase patterns and equivalents`)
- If enabling `pytest-randomly`, always preserve the printed seed for reproduction (`--randomly-seed=<seed>` or `last`). (Web: `https://github.com/pytest-dev/pytest-randomly#readme`)
- `factory_boy` random/Faker-backed values should be constrained when assertions rely on exact values; prefer explicit fields or stable `Sequence` usage for contract tests. (Context7: `/websites/factoryboy_readthedocs_io_en_stable` topic `DjangoModelFactory patterns, SubFactory, RelatedFactory, and deterministic faker/sequence practices`)
- `responses`/`respx` are intentionally skipped for now because current contract tests do not mock outbound HTTP calls.
